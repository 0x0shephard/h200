name: H200 GPU Pricing Pipeline

on:
  # Run every 12 hours (at 00:00 and 12:00 UTC)
  schedule:
    - cron: '0 */12 * * *'

  # Allow manual trigger
  workflow_dispatch:

  # Optional: Run on push to main/master branch
  # push:
  #   branches:
  #     - main
  #     - master

jobs:
  scrape-and-index:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run all H200 scrapers
        run: |
          echo "=========================================="
          echo "STEP 1: Running all H200 scrapers"
          echo "=========================================="
          python3 run_all_h200_scrapers.py
        timeout-minutes: 15

      - name: Calculate H200 weighted index
        run: |
          echo "=========================================="
          echo "STEP 2: Calculating H200 weighted index"
          echo "=========================================="
          python3 calculate_h200_index.py
        timeout-minutes: 5

      - name: Push to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "=========================================="
          echo "STEP 3: Pushing to Supabase"
          echo "=========================================="
          python3 push_to_supabase.py
        timeout-minutes: 5

      - name: Push to Oracle Contract
        env:
          SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}
          ORACLE_UPDATER_PRIVATE_KEY: ${{ secrets.ORACLE_UPDATER_PRIVATE_KEY }}
          MULTI_ASSET_ORACLE_ADDRESS: ${{ secrets.MULTI_ASSET_ORACLE_ADDRESS }}
        run: |
          echo "=========================================="
          echo "STEP 4: Pushing to Oracle Contract"
          echo "=========================================="
          PRICE=$(jq -r '.final_index_price' h200_weighted_index.json)
          python3 push_to_contract.py $PRICE
        timeout-minutes: 5

      - name: Push Provider-Specific Prices to Oracle
        env:
          SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}
          ORACLE_UPDATER_PRIVATE_KEY: ${{ secrets.ORACLE_UPDATER_PRIVATE_KEY }}
          MULTI_ASSET_ORACLE_ADDRESS: ${{ secrets.MULTI_ASSET_ORACLE_ADDRESS }}
        run: |
          echo "=========================================="
          echo "STEP 5: Pushing Provider-Specific Prices"
          echo "=========================================="
          echo "Pushing 5 provider prices (AWS, Azure, GCP, Oracle, CoreWeave)"
          python3 Push_h200_provider_specific_markets.py --from-index
        timeout-minutes: 5

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: h200-pricing-data-${{ github.run_number }}
          path: |
            *_h200_prices.json
            h200_combined_prices.json
            h200_weighted_index.json
            h200_oracle_update_log.json
            h200_price_update_log.json
          retention-days: 30

      - name: Pipeline Summary
        if: always()
        run: |
          echo "=========================================="
          echo "PIPELINE EXECUTION SUMMARY"
          echo "=========================================="
          if [ -f "h200_combined_prices.json" ]; then
            echo "✅ Combined prices file generated"
            jq -r '.price_summary[] | "\(.provider): $\(.price)/hr"' h200_combined_prices.json | head -10
          else
            echo "❌ Combined prices file not found"
          fi

          if [ -f "h200_weighted_index.json" ]; then
            echo ""
            echo "✅ Weighted index file generated"
            FINAL_PRICE=$(jq -r '.final_index_price' h200_weighted_index.json)
            echo "Final Index Price: \$$FINAL_PRICE/hr"
          else
            echo "❌ Weighted index file not found"
          fi

          if [ -f "h200_oracle_update_log.json" ]; then
            echo ""
            echo "✅ Oracle contract updated (index price)"
            LATEST_TX=$(jq -r '.[-1].tx_hash' h200_oracle_update_log.json)
            echo "Latest transaction: $LATEST_TX"
            echo "Etherscan: https://sepolia.etherscan.io/tx/$LATEST_TX"
          else
            echo ""
            echo "⚠️  Oracle contract update log not found"
          fi

          if [ -f "h200_price_update_log.json" ]; then
            echo ""
            echo "✅ Provider-specific prices updated (5 providers)"
            LATEST_TX=$(jq -r '.[-1].tx_hash' h200_price_update_log.json)
            PROVIDER_COUNT=$(jq -r '.[-1].prices | keys | length' h200_price_update_log.json)
            echo "Providers updated: $PROVIDER_COUNT"
            echo "Latest transaction: $LATEST_TX"
            echo "Etherscan: https://sepolia.etherscan.io/tx/$LATEST_TX"
            echo ""
            echo "Provider prices pushed:"
            jq -r '.[-1].prices | to_entries[] | "  \(.key): $\(.value.price_usd)/hr"' h200_price_update_log.json
          else
            echo ""
            echo "⚠️  Provider-specific price update log not found"
          fi
